import streamlit as st
import random
from models.graph import Spot

data = st.session_state.app_data

st.header("⚙️ 调试功能：自动生成测试数据")
st.info("此页面用于快速填充系统数据，方便进行功能测试。")

st.subheader("当前数据概览")
col1, col2 = st.columns(2)
col1.metric("景点数量 (Nodes)", value=data.graph.nodes)
col2.metric("道路数量 (Paths)", value=data.graph.paths)

with st.expander("点击查看当前原始 JSON 数据"):
    st.json(data.model_dump_json())

st.divider()

st.subheader("生成新的随机数据")

st.warning(
    "⚠️ **注意：** 此操作将首先 **清空所有** 现有的景点和道路数据，然后生成全新的随机数据。此过程不可逆！"
)

if st.button("生成 8 个景点和 15 条随机道路", type="primary"):
    try:
        data.graph.spots.clear()

        spot_names = [
            ("广东工业大学", "广东工业大学是一所以工为主、工理经管文法艺教结合、多科性协调发展的省属重点大学、广东省高水平大学重点建设高校，1958年开办本科教育，1995年由原广东工学院、广东机械学院和华南建设学院（东院）合并组建而成。2025泰晤士高等教育世界大学排名位列大陆高校第45—59位，2025软科世界大学学术排名位列全球第301—400名。"),
            ("华南理工大学", "华南理工大学地处广州，是直属教育部的全国重点大学，校园分为五山校区、大学城校区和广州国际校区，是首届“全国文明校园”获得单位。学校办学源远流长，最早可溯源至1918年成立的广东省立第一甲种工业学校（世称“红色甲工”）；正式组建于1952年全国高等院校调整时期，是新中国“四大工学院”之一；1960年成为全国重点大学；1981年经国务院批准为首批博士和硕士学位授予单位；1993年在全国高校首开部省共建之先河；1995年进入“211工程”行列；2001年进入“985工程”行列；2017年进入“双一流”建设A类高校行列，2023年跻身上海软科“世界大学学术排名”前150强。"),
            ("华南农业大学", "华南农业大学是国家“双一流”建设高校。校园坐落在素有“花城”美誉的广州市，土地总面积8211亩，其中天河五山校部4407亩，增城教学科研基地3804亩。学校建筑总面积140万平方米，自然景色与人文景观交相辉映，形成了“五湖四海一片林”的优美环境。"),
            ("广州美术学院", "广州美术学院前身是中南美术专科学校，是根据国家建设布局，于1953年组建于湖北武汉的专门美术院校，时由中南文艺学院、华南人民文学艺术学院、广西省立艺术专科学校等院校相关系科和人员合并而成。首任校长为参加过延安文艺座谈会的著名革命美术家胡一川，首任副校长为著名油画家杨秋人、著名国画家关山月和阳太阳。"),
            ("星海音乐学院", "星海音乐学院由1957年创办的广州音乐学校发展而来，后数易校名、几经转制分合，育人初心矢志不渝。1958年9月升级为广州音乐专科学校，1966年1月与广东舞蹈学校合并为广东艺术专科学校，1970年10月与广州美术学院共同组建广东人民艺术学院，1978年3月复名为广州音乐专科学校，1981年6月经国务院批准设为广州音乐学院，1985年12月为纪念人民音乐家冼星海，更名为星海音乐学院。"),
            ("中山大学", "中山大学是伟大的民族英雄、伟大的爱国主义者、中国民主革命的伟大先驱孙中山先生于1924年亲手创办，中国共产党早期领导人共同创建的大学，是中国传播马克思主义的重要发源地之一，具有优良革命传统、爱国奋斗精神和卓越品格追求。中山大学起初校名为国立广东大学。孙中山先生逝世后，学校于1926年定名为国立中山大学。"),
            ("华南师范大学", "华南师范大学是国家“双一流”建设高校、“211工程”重点建设大学、广东省和教育部共建高校及广东省高水平大学重点建设高校。现有“三校区四校园”，包括广州校区石牌校园、大学城校园，佛山校区南海校园和汕尾校区滨海校园。学校设4个学部、35个学院、9个研究院（中心）。"), 
            ("暨南大学", "暨南大学是中国第一所由政府创办的华侨学府。“暨南”二字出自《尚书·禹贡》：“东渐于海，西被于流沙，朔南暨，声教讫于四海。”意即面向南洋，面向海外，将中华文化远播到五洲四海。学校是由中央统战部、教育部、广东省人民政府共建的国家“双一流”建设高校，直属中央统战部管理。")
        ]

        for i, (name, description) in enumerate(spot_names):
            new_spot = Spot(
                id=i, name=name, description=description, deleted=False
            )
            data.graph.spots.append(new_spot)

        num_spots = len(data.graph.spots)
        generated_paths = set()

        while len(generated_paths) < 15:
            from_id, to_id = random.sample(range(num_spots), 2)

            path_key = tuple(sorted((from_id, to_id)))

            if path_key not in generated_paths:
                generated_paths.add(path_key)

                distance = random.randint(100, 1500)
                duration = random.randint(5, 25)

                data.graph.add_path(from_id, to_id, distance, duration)

        data.save()
        st.toast("测试数据生成成功！", icon="🎉")
        st.rerun()

    except Exception as e:
        st.error(f"生成数据时发生错误: {e}")
